# TypeScript/React テストガイドライン

TypeScript + React 環境でテストを書く際の観点と運用ルールをまとめる。

---

## テスト方針

- 主要ツールとして `Vitest` と React Testing Library を用いる。UI の振る舞いはユニットテストで担保し、E2E では Playwright を併用する
- アプリケーションロジックに関与しない補助的な処理（例: logger）はテスト対象外としてよい
- **`docs/tests/tips.md` を常に参照して、翻訳ヘルパーやモックの扱いを統一する**
- **TDD の詳細な考え方は `docs/tests/TDD.md` を参照する**

---

## テスト観点

- UI 状態遷移（初期、ローディング、成功、失敗）を観測し、分岐ごとにアサートする
- ユーザー操作（クリック、キーボード入力、フォーカス移動）のイベント連鎖を検証する
- 非同期処理の整合性を確認し、タイムアウト・再試行・キャンセルを含めてテストする
- アクセシビリティ属性（role, aria-\*）やタブ移動の挙動を検証する
- i18n や数値フォーマットなどロケール差分をテストでカバーする
- 境界入力とエラー表示、バリデーションメッセージをアサートする
- キャッシュやメモ化の再レンダリング抑制効果をテストで確認する

---

## TDD ワークフロー

1. `*.spec.tsx` に UI／ユースケースの期待挙動を記述し、失敗するテストを先に作成する（React Testing Library を利用する）
2. 最小限のコンポーネント実装や Hook でテストを Green にする。UI に依存しないロジックは純粋関数として切り出す
3. 副作用や外部依存はスタブ・モックで隔離し、最終的にアダプター層へ押し出す
4. Green の状態でリファクタリングして責務を整理する。型補完と ESLint を活用して一貫性を保つ
5. フローの途中でテストを追加する場合も Red → Green → Refactor を崩さない

---

## テスト配置と命名

- テストファイルは `src/tests/` 配下に置き、対象コードと同じディレクトリ階層を再現する
- ファイル名は `<ComponentName>.spec.tsx` の形式とする
- 1 コンポーネント 1 ファイルを基本とし、関係の深いユーティリティは同テスト内で扱う

---

## 記述スタイル

- `describe` / `it` でシナリオを整理し、テストケースの説明は日本語で記述する
- 共通セットアップは `beforeEach` / `afterEach` で行う
- `expect` で期待値を表現し、必要に応じてカスタムマッチャーを導入する
- `Vitest.fn()` や `vi.mock` を用いて依存関係を検証する

---

## コンポーネント固有の指針

- DOM 取得は `data-testid` を基本とし、ID は `constants/testIds.ts` で一元管理する
- `getByTestId` を優先し、テキスト検証が必要な場合は i18n キーを `getByText` で参照する
- UI 振る舞いとロジックを分離するため、イベントハンドラや副作用は Hook に集約する

---

## 運用とコマンド

- コード変更とテスト変更は同一コミットで扱い、Pull Request では差分をセットで提示する
- 型検査は `pnpm tsc -b`、単体テストは `pnpm test {ファイル名}`、全体実行は `pnpm test` を使用する
- タイムアウト延長などテスト実行ポリシーを変更する際は事前にチームへ共有する

---

## テスト資産のメンテナンス

- 翻訳ヘルパーなどの依存物はテストごとに生成して分離性を保つ
- 新しい知見や Tips が得られた際は `docs/tests/tips.md` に追記する
- テストが肥大化した場合は責務ごとに分割し、読みやすさを優先する
